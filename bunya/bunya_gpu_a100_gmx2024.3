#!/bin/bash -l

#SBATCH --job-name=prod
#SBATCH --output=prod
#SBATCH --time=00:05:00
#SBATCH --partition=gpu_cuda
#SBATCH --qos=mig
#SBATCH --nodes=1
#SBATCH --ntasks-per-node=1
#SBATCH --cpus-per-task=16
#SBATCH --mem=64G
#SBATCH --gres=gpu:nvidia_a100_80gb_pcie_1g.10gb:1
#SBATCH --constraint=cuda10gb
#SBATCH --account=a_omara

# Load compilers and tools
module load gcc/11.3.0
module load cmake/3.24.3-gcccore-11.3.0
module load python/3.11.3-gcccore-12.3.0

# Source relevant gromacs installation
source /scratch/project/omara_scratch/gromacs/gromacs_2024.3_a100/bin/GMXRC


# grompp and mdrun for just a 5 minute benchmark in this case

gmx grompp -f prod.mdp -r prod_start.gro -c prod_start.gro -p prod.top -n prod.ndx -o prod.tpr -maxwarn 2

gmx mdrun -v -deffnm prod -nb gpu -bonded gpu -ntmpi 1 -ntomp 16 -maxh 0.08

# Do some benchmarking to get best speeds and GPU utilisation by changing -ntomp (some good performance can be achieved with even 2 cores and 1 GPU slice) and if needed, -ntmpi
# GPU performance varies significantly per GPU, per system, per configuration
